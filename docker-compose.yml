version: '3.7'

# Template chuẩn cho các OpenIG Node
x-openig-template: &openig-template
  build:
    context: ./openig-base
  networks:
    - openig_net
  # Giải quyết vấn đề metadata URL mismatch
  extra_hosts:
    - "localhost:172.22.0.2"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/"]
    interval: 5s
    timeout: 5s
    retries: 5
    start_period: 20s

services:
  # --- Identity Provider (Keycloak) ---
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    command: start-dev --http-relative-path /auth
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HOSTNAME_STRICT=false
      - KC_PROXY=edge
    networks:
      openig_net:
        ipv4_address: 172.22.0.2
    ports:
      - "9080:8080"

  # --- Gateway Layer (Active-Active) ---
  openig-node1:
    <<: *openig-template
    environment:
      - OPENIG_NODE_ID=node1
    ports:
      - "8081:8080"
    volumes:
      - ./configs/tomcat-node1/server.xml:/usr/local/tomcat/conf/server.xml
      - ./configs/tomcat-node1/logging.properties:/usr/local/tomcat/conf/logging.properties
      - ./configs/openig:/root/.openig/config
      - ./configs/openig/scripts:/root/.openig/scripts

  # --- Gateway Layer (Active-Active) ---
  openig-node2:
    <<: *openig-template
    environment:
      - OPENIG_NODE_ID=node2
    ports:
      - "8082:8080"
    volumes:
      - ./configs/tomcat-node2/server.xml:/usr/local/tomcat/conf/server.xml
      - ./configs/tomcat-node2/logging.properties:/usr/local/tomcat/conf/logging.properties
      - ./configs/openig:/root/.openig/config
      - ./configs/openig/scripts:/root/.openig/scripts

  # --- Load Balancer Layer (The "F5") ---
  nginx-lb:
    image: nginx:latest
    depends_on:
      - openig-node1
      - openig-node2
      - keycloak
    ports:
      - "80:80"
    volumes:
      - ./configs/nginx-lb/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - openig_net

networks:
  openig_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
