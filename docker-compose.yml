version: '3.7'

# Define common configuration for any OpenIG node
x-openig-template: &openig-template
  build:
    context: ./openig-base
  environment:
    - TARGET_APP_URL=${TARGET_APP_URL:-https://www.google.com}
    - KEYCLOAK_URL=${KEYCLOAK_URL:-http://keycloak:8080}
  networks:
    - openig_net
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/"]
    interval: 5s
    timeout: 5s
    retries: 5
    start_period: 20s

services:
  openig-node1:
    <<: *openig-template
    environment:
      - OPENIG_NODE_ID=node1
    ports:
      - "8081:8080"
    volumes:
      - ./configs/tomcat-node1/server.xml:/usr/local/tomcat/conf/server.xml
      - ./configs/tomcat-node1/logging.properties:/usr/local/tomcat/conf/logging.properties
      - ./configs/openig:/root/.openig/config
      - ./configs/openig/scripts:/root/.openig/scripts

  openig-node2:
    <<: *openig-template
    environment:
      - OPENIG_NODE_ID=node2
    ports:
      - "8082:8080"
    volumes:
      - ./configs/tomcat-node2/server.xml:/usr/local/tomcat/conf/server.xml
      - ./configs/tomcat-node2/logging.properties:/usr/local/tomcat/conf/logging.properties
      - ./configs/openig:/root/.openig/config
      - ./configs/openig/scripts:/root/.openig/scripts

  nginx-lb:
    image: nginx:latest
    depends_on:
      - openig-node1
      - openig-node2
    ports:
      - "80:80"
    volumes:
      - ./configs/nginx-lb/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - openig_net

networks:
  openig_net:
    driver: bridge
